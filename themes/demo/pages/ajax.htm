title = "Ajax"
url = "/ajax"
is_hidden = 0
==
<?
use Illuminate\Support\Facades\DB;

function onStart()
{
   $table = $_GET['tb'];
   $length = $_GET['length'];
   $start = $_GET['start'];
   $fields = explode("|", $_GET['fd']);
   $searchVar = $_GET['search']['value'];

   $columnSortOrder = $_GET['order'][0]['column'];
   $sortBy = $_GET['order'][0]['dir'];

   //echo "<script>console.log('".$fields[$columnSortOrder]."')</script>";

   if ($searchVar != '') {
     $result = DB::table($table)
               ->where('app_name', 'like', '%'.$searchVar.'%')
               ->orWhere('app_id', 'like', '%'.$searchVar.'%')
               ->orderBy('idx', 'desc')
               ->get();
   } else /* if ($columnSortOrder != 0) */{
     $result = DB::table($table)
               ->skip($start)
               ->limit($length)
               ->orderBy($fields[$columnSortOrder], $sortBy)
               ->get();
   } /*else {
     $result = DB::table($table)
               ->skip($start)
               ->limit($length)
               ->orderBy('idx', 'desc')
               ->get();
   }*/

   $data = array();

   foreach($result as $row) {
      $sub_array = array();

      for ($i = 0; $i < count($fields); $i++) {

      // echo "<script>console.log('".$fields[$i]."')</script>";

        if ($fields[$i] == 'start_time') {
            if ($row->service_type == 'lite' && !$row->end_time) {
              $sub_array[] = '무제한';
            } else {
              $sub_array[] = $this->calculDate($row->start_time, $row->end_time)." 일";
            }
         } else if ($fields[$i] == 'app_process') {
           $arrProcess = [
               1 => '개발준비중', 2 => '개발진행중', 3 => '심사중', 4 => '등록거부',
               5 => '재심사중', 6 => '등록대기', 7 => '등록완료', 8 => '서비스중지',
               9 => '기간만료', 10 => '서비스유효'
            ];

           foreach ($arrProcess as $key=>$val) {
             if($row->{$fields[$i]} == $key) {
                $sub_array[] = $arrProcess[$key];
             }
           }
         } else if ($fields[$i] == 'script_popup') {
             if ($row->{$fields[$i]} == 'Y') {
               $sub_array[] = '설치됨';
             } else {
               $sub_array[] = '-';
             }
         } else if ($fields[$i] == 'custom_etc') {
            if ($row->{$fields[$i]} != '') {
              $sub_array[] .= $row->{$fields[$i]}." 커스텀";
            } else {
              $sub_array[] = '-';
            }
         } else if ($fields[$i] == 'reg_time') {
            $sub_array[] = gmdate("Y-m-d", $row->{$fields[$i]});
         } else {
            $sub_array[] = $row->{$fields[$i]};
         }
      }
      $data[] = $sub_array;
   }

   $output = array(
     "draw" => intval($_GET['draw']),
     "recordsTotal" => DB::table($table)->count(),
     "recordsFiltered" => DB::table($table)->count(),
     "data" => $data,
   );

   echo json_encode($output);
}

// 기간 계산 종료일 - 시작일
public function calculDate($val1, $val2)
{
    // $today = date("Y-m-d h:i:s", time());
    $dday = (($val2 - $val1) / 86400);

    return ceil($dday);
}
?>
==
